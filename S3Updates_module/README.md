# S3Updates

---
Модуль позволяет синхронизировать папку `updates` с Хранилищем объектов S3
Модуль может использоваться для поставки обновлений через хранилище, снимая нагрузку с лаунчсервера и nginx при обновлениях клиентов.

---
## Установка модуля

1. Скопировать модуль **S3Updates_module.jar** в папку **/LaunchServer/modules/**
2. Создать хранилище в панели управления провайдера
3. Взять у провайдера учетные данные пользователя для доступа к хранилищу и заполнить конфиг файл
4. Перезагрузить лаунчсервер и прописать `syncupdates` или `syncup` (Альтернативно можно воспользоваться командой `s3upload`)
5. Для удаления объектов на хранилище воспользуйтесь командой `s3cleanup`

---
## Конфигурация
* /LaunchServer/config/S3Updates/Config.json
```json
{
  "s3Endpoint": "https://s3.gra.io.cloud.ovh.net/",
  "s3AccessKey": "accesskey",
  "s3SecretKey": "secretKey",
  "s3Region": "gra",
  "s3Bucket": "bucket",
  "behavior": {
    "forceUpload": false,
    "prefix": "updates/",
    "maxConcurrentConnections": 10,
    "maxPendingConnections": 2147483647,
    "connectionTimeout": 30,
    "connectionAcquisitionTimeout": 80
  }
}
```
- `forceUpload` - нужно ли модулю сверять ETag файла на хранилище и локального
- `prefix` - префикс для всех загружаемых объектов (псевдо-директория)
- `maxConcurrentConnections` - количество потоков для загрузки. Можете выставить выше стандартных значений
Используемое в модуле AWS SDK самостоятельно работает с рейтлимитами, но все же лучше не нагружать 
лишний раз лаунчсервер и оставить значение в пределах 20. Загрузка ~1.5Gb занимает около 1.5 минут
- `maxPendingConnections` - размер очереди соединений. Рекомендуется не трогать, по стандарту уже максимальное
- `connectionTimeout` - таймаут HTTP/2 соединения с хранилищем, если у вас случаются таймауты при загрузке или 
нестабильное соединение - рекомендуется повысить
- `connectionAcquisitionTimeout` - таймаут на добавление нового соединения в очередь pending connections

Все остальные данные поставляются провайдером, и могут разниться от провайдера к провайдеру

## Проверенные провайдеры
- [VK Cloud](https://mcs.mail.ru/docs/ru/base/s3/intro#)

## Замечания
Чаще всего провайдеры считают входящий и исходящий трафик до хранилища, уточните цены используемый вами S3 сервис. Так же скорее всего
ваш провайдер поддерживает использование CDN поверх хранилища, для ускорения загрузок и снижения расходов. 
Потенциально вы можете воспользоваться любым другим CDN хостингом, но инструкции по настройке и использованию нужно уточнять у них самих.